workflows:
  android-workflow:
    name: Android Workflow
    instance_type: mac_pro
    max_build_duration: 120
    environment:
      vars:
          CM_KEYSTORE: Encrypted(Z0FBQUFBQmcxS0dUS1NyRXZUbGZxTENPaGxkX1l4UUpWWE5pVDVMc2QtbGlGYWsxWEh2UzNoX0VxbWFzSmg0R0YwTnlPbW03SmUwVjRIbWxTbDQtendDU1RTTWNfS182Zmg4SlppWnk2MTlXY2dOSTBvNVBubWV5Snk4U281MDhSMmhLc2NXVGRyMWhtN3ZNbzMyeVRSbG93TENSS0FKZWtwVDB5YUZla0twZFhQUHAxSE5aaEE4X1RSODJVVjhGanRNSVMtUDd2YXl5aXN4Y3J1a1FBcGhpM2NTNzUtT29RN3I1cW82WkpzbmxTM1lCdkpOVzVzeXhJZVZ0R09IMnNHSktNeEV1ckFsSzVPc0NzcllNR0ptZUpIZmFlQVU4bmpITzlQd0NTbEN0QlRGcjVFbnVtM19iM1BMUlFmZ1N5V0JveFphMEhYV0ctaUhTMUtlX1dtSVJJbzlmaHV1LXY1QjZjdlFxN3JsS0dHNmZIR25lejBZZVRhTTJGZnVfWUk1NGRaaXJGeVU1SUFpX3Z5MXVZTzh3WExOVnhsVGVIcndaTkd2NVRiN08xdjJ6dmlESk9jQUlsRVlncWpETkhqcXRzNWNiSVl0ZHZPUVk2dU1ManN4U3J3dlQwb1pqUEMwU3dvcGRJOFBYZElaNEozSVJGeDRXN09JbHh1SHVuVURGQXFQeHZMU2tKYUhrbHFaX2MyRjViYjR4angtaDZfTkpqMWtwUVhBRkFhT0FtNFZDYy1DNTh3N3JQRU9iSnpqTFU2QWZyZmNEOHdvakFCSlRsMFdiNWJDdWgwdVgxTW5DUXIxZHlPbFllQ2NjMXlVUDVwRXVnaFQ1NEZranJGMW1VQkw4SGZDWlJXcTFWRDJBRWU1LTVGLWJ1bURWeU8tZnRZd1hyUUw1aUxpdmNJc1hlN2hpOHB4VEthVG80RXMtdnRiUnVYYjZLY2hNdXdudkxFSUJoa1V1Ti03c3M2QmQ4RzNKSDd3T29NSENYU18tX0FOUjFka0w1b2RCQTdhYVFDZDRfYTdMMzNSRFpUejlXRUxYaWszU21NTVFBWU1RMS1xWWlHLWp0NEtUVUNiaTM2bEljSWREUVJUZzNBY05mUmdxZHZ5b0RoRUpreHh4bHlKb01sMFR1VlJCT2p2NUVOSjlMY09FUjA2c2tOQUdEU0QzSTd5WFB4X1gtdWxsZC02NWY3eXo5Y1hqZzhSTVBOMC02WWxFM2tJWWJDLS1vaU9CR2RiRUxHdUo2TFpXaUI4M25ya3dCc0V5dWpLajR6RnlSTFh0MFJhR2o0NGpCbi1KUDEwaUdlMmUwdDVWT2dKbnZqVXVNeER4aUhlZExRelRPWUpITGxJTUI5RUtmMEl5cnlhMnltaXM1cVJTWjBqWlFlSk01ODZUd1YzVzJXUUdjTGlyeFZncVQxbWFpZURiQzIwanFlUS0tVU1yTmE4SFYxeHhwREpkWWI1eXVqOXRGUGEwWUhYbktjQXo2OTk5SklHZDBZZGo1cjBmbWFHZEZFYlNlVDR3RUM2Umt1NVNfak5OQWhHMU5NbVQ5a3BySmNPNUs0NGY4bEN6aDFCTk5rNGdxQXowUHhPd1RFY3ZXVVg4N3B4TmZRR053VW5ldDRfQlBrX3pnb0ZCVGI0Q2ZKWlkxRkpMaE1BVTFTdDk4ZDlqWVoyU2l4RXA0Tm8wZkZqUmFjUFNPdzdmaERKY0NuLW1NQTZOanV6RzVfTlRPWmNKaExNSzJ1YVZzaWtzZzJFMFd4Z3VaWjhUR3E5bVR3MEY4OU1rYjBFeWVCY1phZTJGc0hRdFdTanJlbDJjdGdtcFJMTnItZHBmMVo2aloxNENDOVlGOWdmNDBJYm5UNURwVmlleFVqTHRvZnVpa0I0RENCaVFzZW9tNkk2dWduX1JBQkVid2JUeXJNaUVuWDR1WVphZlUxSU1IUnN3cG9RcEl2RFB3WGllVHd4c2kwemtDQkVwQTlTODN3eUhIUkk1NDc5SXBFNXVFd1lOaEgzR0s2VkVvZWo0V1EyVm0wZFNiVC1xZHFtM19ObGVTV0paX0M5Mk1fZWtsMTgxSTh3TDUxQVBNa3MwUm1RQXNSUWdSSTZxQ0NabVFCM19jZEhsVzZuV3owOEk2UnlUVW5fdnVXb3N4c052QmdsNTlDcjYxa3BHaXV2TmpFSUlmQXo2bWkyU0NsSFoza1Q3cjVLcS1ZaVpCVks1Yy1CeVhNY2dkVk1aZWxyX1lKeERnOXhqaF81MlZZSkdLZHRxT1RYQnRtVU9jMzRTeEZzTEVidTlPLWw5a2NIdk16NnU1dHR5ZlBvSmZpeGpNYzRYTjlWUWhyTWE0aWdXdjlGZC11Z3gwVnZlM2hqcUtWNDZDazlFWmlQdkUxZTI3LVBIQ2NtOHVqSlJ0RmlMeDhkT2pPV05DMGdEZzJWa2FPa3YxVkktTkJaal9FOGpGU1BSRFdFMmZZRDlTQmtTTW53dUFGeHRnemlxYktHZHYzS0otdkR2NXZvd3VDT1BwdVYyQjZLN09kLTRpV3RmUEFfMW1HVkpoc2hYMUVTZVZFeXdMNFVfX0IxU2k2NFR1YVpIOG04dFZnSF8wRmdSZlRoQnE0Mi1XdG1SOUo3b2dVWjJxTWluOFFIbnQ5TnY2ZzlPM3RYa19LTUMxNWtDcVF0WEpSUUxoV2RSQUMxSjNBOHdKNF91VVlnLXJJNWF1WVA3cVNtbW5KS2ZXOWV2U0MzOV9uSzdKOW54S19QTER6eEZyRmo4Q0pXeGFMSXdpY3M2S2ZzR0IwMFNINDlaUERxV1NuZmwzUjZNRzBqN2ttMDB6TVNtSzR5R00xdjlrRDBXTTBMdXA3dUlrS29zbzhBZlgzM3F4c1FRQjhYLVNHTjJSR3Ixd1prX1FLSlYySVRCdVZCakxYaW1BajlBUzh3d29hMEY4OG1nMVFuZ2c4ampWdm9vaDdmbkdzYjE1VzJ0djRKWUh2SlA1YUFwVXR6QlVJaUwyWGxQa1BaZWo0Rm5kUm9Id0xwYnZrZEJodXk5ZmlPcEs2ZmdhSU9vTmF3ZWw0TExCSTh5MkJ1Zlc0bVZTZlFseEdYVG4tZDZodVFjQUQ3OUNPTVFLRllxZkpEYVVRT0hOQVdyM2RheGhJNGFEUEpEMXA3Rmw0UnFXbGthYW9NX3p6RGtNMUNZQVNNSDBJZm5WUkpIZ2tLdk9Qb3h2d1I0bUFYNVBpNXpUcnBWMV9LNlIwSDA5XzFqaGJhVFk4ZFRSZTZjTEU5SnhPRVBMWjJvWGZTa3RRLUhITkZNX2xOTDRFRkpXU1FUVkpMakk0aUZldDJIWEhmTWFlRWRfYkpXQVVEUnowby1ESGRYcTAyNmJaVXl5clhvcE9lLUFUVmY5dnA2OThWcy1iMVFvNE9Kdmpic202NzVFdTZlMVJEMFcwLWkxdmZ2c1J2eXpTeTF5TFNxVWlKcE1PMlBTMktsQTFxSGFLTVpNRklzeEhMSUNvYXU5Vm04elJaVUk0LUZfdkhsNW1PNXVPOW96V1pEZ2VXRTZneHZoN2w5YlE2NlFHSmFIYmsxektsM081aXh1amNHV2FLLVRhTUJhdHhpaHUtZ1dVZmlIVkdUSWE5VkNYRkFmZFFKWlU1Rk03S2xlR2xZME5aUnBIXzlELU9wQzVrUzVqSnU2Qzh3YVEtakNIQ1RQM0VaczJoWkJnZXFWWnREbFFvVWhodWUwbTE5bTN4UEplZU11R20yR2NCeTRRSC15bmd6V1pDYWVTZVFPY1d3SXlGdFJmMG1FaXFzM1NQOV9BRHZqcERoT2Rzd05xc0tMRWRXYlFic19sNVF5WDF3amhudWIzU1ZSUkQyUXV1VTY3X2dLVnBBU0UtWTRQbm9QWjZxQmJMOW9vSXVhTy1qSHJ0ajdmQ3BXQTRoV0NxOXg4NFZMLURyQTR2eWI2ZkxVVWtKT29ZdWVNMWZQY2tnRV9hLWkzbmJ6STZiYmR1OUppZnZRSUlsWnpjXzhqRnFGeFdsc2JsZm9JUDUzc0d1bTg4MW9YSnVvV2ItOVI2UXJsWHdKZkxxM0ozV1RSMUF3bTZyak4wVng5aERXWlNZcjdFcjZIMjYzUFpuTGdPSmMxNkUxdnhzTVdQcFFjSXZnT0MwMW1IbEI2UEFOYXRRLXktVE00UGJSYlB4YXdZTzE0OHBjY090cGlFc3h4SnRJRDhLTGw4amJoRTlndEN5NXpGZEFYc0pRNVhndk84ODF6NERTd0l4UjFxZHUwTklWS2lzVGxUbXo3Q1NuQkZVTnBFTVFvOEJwc1VkZ1VUdHU0UWs2RWpVSF9la0FyRkVXVTNEVExwNnBmemZSX0V6ZFlYU1poX3VsQ2tRWEp2RUZyTGdWal90cEhlbWNzREZpWjBSMVJmbllhdGMwTzdULWZuRlRYak1lTnFXTVdyX3diNGZwLTFpNFJNWFJubGFLVXlSZlV6b2dRTm1iY0JCQzNySzk4Q196a0pKclp3T1VtN1VKUXk0cDR3dW0zcWVQeG50S2xJY1VRUUJVM1dMajhXRk04TUtSRUJsekVzdlg4NXhoUC1GYlp0aU0tdHFwN09mMjNWLXQtNEFqLVktQTNleDRvdkFmMU1ubDh3N0EzbWc1bE1FbzdRcVBCTEdXMzZlZWZkR2QzYmR1aG9teXhxZTBEWThQTm5oU2g5V2c1bjRJSkdYbjZlakZEVHBLemh5WXdJNGo5QjNiZlEwMlJIS2FnbGFWX2NBeHZmWDNLSWVuZzZaQlBHTjJrbjczZHFlcFQ4YmgwX1U0X2IybTBWZVd0ZWg1Rm9zZjFaTHZUZExvX21lVXdMSzFmSDNpVjRhb2NMU2MzdWhZUE1yNFJpRTZkYzV5NEpLLU9sd1R3UlREanFvaFZYRmV1dlUxV1Z6WlIwbm4tMmIwNTlXM3RiQ3dtVXRWQ2dCSVBnS01qX0MxRHlENnlOUnBZNXVzYVZ3Ung4aDlyS0dzbzMyX1l6ekg5YU1lVVBOZ0xBS3ZneGwwQTlKcjhZeFpDalcxamFHMGVGV1pUdTRuMWJwZ2llb0FXN2xFaGstS0t4dWwyTURXdWd0c2lnaW5uNzc2alVFOFhnakhwbEtDa2VkdGJoSm8zalVTUF9WSE1TSlc5YllDYkhlNzVTS1RLTnp3Q0Z2c1FiSFNuZXFPTXk2UUZlQVp4VExndWxaQ2Jqc3lRSEdHTmdSUk80T0I3dUVMYnlfa3lvTnVNYXJmR2VEd3RVLWJNN1h6YnpHZkczN0Fzd01nNXdIanc2eUZpRkVCNk5JR0pveHNCcDNjaXZhZUcxR0RCSmhjV3FHZHhPbEc5UzhBQmVNLVgzR3dSekplbDMxbGdfVTJLTnhSM0FTWjZzZ05ZSlg4UE44V2pOcUdPVDN0RE4wbVZ3bjVjM29EYjZTSjlaMWJ6NV9QXzRtVTYwVURpTT0=) # <-- Put your encrypted keystore file here
          CM_KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmcxS0d0RUZ2R0Q2bEMyZGEzMkhhQTlnMXhiYzZCZWE2YzV4U3YzV1dPQW80dTVpU0hXbDAySHNfWXV1TG1jdFgtUWhfbktLbEVWUDFicGN0TFNVLWh1dEpfU0E9PQ==) # <-- Put your encrypted keystore password here
          CM_KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmcxS0d0RUZ2R0Q2bEMyZGEzMkhhQTlnMXhiYzZCZWE2YzV4U3YzV1dPQW80dTVpU0hXbDAySHNfWXV1TG1jdFgtUWhfbktLbEVWUDFicGN0TFNVLWh1dEpfU0E9PQ==) # <-- Put your encrypted keystore alias password here
          CM_KEYSTORE_PATH: /tmp/keystore.keystore
          CM_KEY_ALIAS_USERNAME: Encrypted(Z0FBQUFBQmcxS0hNSjlhM3dySkxIdlJZMnFlcjc2cUwxLXdrTWFiN0N0TVc1SDhiUmZ4U1RsSnFfb29nR3N6aVFwSDJhLVBBeUZySmJsQ3Q4R0tOQzl1RUpYckZuVWhBY0E9PQ==) # <-- Put your encrypted keystore alias username here
          # CODECOV_TOKEN: 53285802-f961-49d3-95f8-a977b7f7d87a
          CODE_COVERAGE_TARGET: 80
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up key properties
        script: |
          echo $FCI_KEYSTORE | base64 --decode > /tmp/keystore.keystore
      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$FCI_BUILD_DIR/android/local.properties"
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get      
      - name: Testing
        script: |
           HOMEBREW_NO_AUTO_UPDATE=1 brew install lcov
           flutter test --coverage
           code_coverage=$(lcov --list $FCI_BUILD_DIR/coverage/lcov.info | sed -n "s/.*Total:|\(.*\)%.*/\1/p")
           echo "Code Coverage: ${code_coverage}%"
           if (( $(echo "$code_coverage < $CODE_COVERAGE_TARGET" | bc) )); then exit 1; fi  
      - name: Build APK with Flutter  
        script: |
          cd . && flutter build apk --release --build-name=1.0.0 --build-number=$(($(google-play get-latest-build-number --package-name "$PACKAGE_NAME" --tracks="$GOOGLE_PLAY_TRACK") + 1))
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
